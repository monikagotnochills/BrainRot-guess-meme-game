// Enhanced Italian Brainrot Horror Game Data
const gameData = {
  gameRounds: [
    // IDs 1‚Äì5: Tung Tung Sahur
    {
      id: 1,
      clue: "He once tried to microwave an NFT to mint it faster.",
      options: ["Tung Tung Sahur", "Wombo Combo", "Ligma Lantern"],
      correct: 0,
      character: "Tung Tung Sahur",
      characterImage: "assets/characters/shahur.jpeg"
    },
    {
      id: 2,
      clue: "His heartbeat sounds like dial-up internet and he uses it to summon crows.",
      options: ["Crypto Pigeon", "Mr. Gobbledy", "Tung Tung Sahur"],
      correct: 2,
      character: "Tung Tung Sahur",
      characterImage: "assets/characters/shahur.jpeg"
    },
    {
      id: 3,
      clue: "This entity legally married a meme template in 2023 and claims they have 5 children: JPEG, PNG, MP4, WebM, and WEBP.",
      options: ["Tung Tung Sahur", "JPEG Jester", "Meme Monk"],
      correct: 0,
      character: "Tung Tung Sahur",
      characterImage: "assets/characters/shahur.jpeg"
    },
    {
      id: 4,
      clue: "He doesn't speak. He just opens Notepad and types 'tralala tralelero' until the power goes out.",
      options: ["Alt Tab Baba", "Tung Tung Sahur", "CTRL+Freak"],
      correct: 1,
      character: "Tung Tung Sahur",
      characterImage: "assets/characters/shahur.jpeg"
    },
    {
      id: 5,
      clue: "He once challenged ChatGPT to a staring contest and lost‚Äîbut claimed it was a strategic surrender.",
      options: ["Broken Compiler", "Tung Tung Sahur", "Sir Lagalot"],
      correct: 1,
      character: "Tung Tung Sahur",
      characterImage: "assets/characters/shahur.jpeg"
    },

    // IDs 6‚Äì10: Chimpanzini Banini
    {
      id: 6,
      clue: "He once swapped his soul for a Solana NFT... then flipped it for 0.0001 SOL and said it was 'for the culture'.",
      options: ["Ape Donda", "JPEG Pope", "Chimpanzini Banini"],
      correct: 2,
      character: "Chimpanzini Banini",
      characterImage: "assets/characters/banini.jpeg"
    },
    {
      id: 7,
      clue: "He launched a DAO to decide what sock he wears. Still hasn't reached quorum.",
      options: ["Monkemon", "Chimpanzini Banini", "Banana DAO CEO"],
      correct: 1,
      character: "Chimpanzini Banini",
      characterImage: "assets/characters/banini.jpeg"
    },
    {
      id: 8,
      clue: "This dude tried to mint a banana by yelling 'sudo mint üçå' at his fridge.",
      options: ["Ruggy Balboa", "Chimpanzini Banini", "GasFee Goblin"],
      correct: 1,
      character: "Chimpanzini Banini",
      characterImage: "assets/characters/banini.jpeg"
    },
    {
      id: 9,
      clue: "When the market dipped, he just screamed 'floor it' and threw a banana at his screen.",
      options: ["JPEG Monk", "Chimpanzini Banini", "Dipnutz"],
      correct: 1,
      character: "Chimpanzini Banini",
      characterImage: "assets/characters/banini.jpeg"
    },
    {
      id: 10,
      clue: "Once said 'I meditated and the banana told me to sweep the floor'. Proceeded to buy the whole NFT collection.",
      options: ["BananaMancer", "Monk.eth", "Chimpanzini Banini"],
      correct: 2,
      character: "Chimpanzini Banini",
      characterImage: "assets/characters/banini.jpeg"
    },

    // IDs 11‚Äì15: Bomberdino Cocordilo
    {
      id: 11,
      clue: "He once bit his own tail just to see if it was emotionally available.",
      options: ["Snapzilla the Therapist", "Bomberdino Cocordilo", "Dr. Tearsaur"],
      correct: 1,
      character: "Bomberdino Cocordilo",
      characterImage: "assets/characters/crocodilo.jpeg"
    },
    {
      id: 12,
      clue: "He started a war over someone stepping on his invisible imaginary friend.",
      options: ["Captain Unstable", "Screamo Gator", "Bomberdino Cocordilo"],
      correct: 2,
      character: "Bomberdino Cocordilo",
      characterImage: "assets/characters/crocodilo.jpeg"
    },
    {
      id: 13,
      clue: "He doesn‚Äôt believe in doors. He just explodes through emotional walls instead.",
      options: ["Bomberdino Cocordilo", "Monsieur Kaboom", "Emotional Alligator"],
      correct: 0,
      character: "Bomberdino Cocordilo",
      characterImage: "assets/characters/crocodilo.jpeg"
    },
    {
      id: 14,
      clue: "Every time he hiccups, someone in a 5km radius gets a minor existential crisis.",
      options: ["Bomberdino Cocordilo", "Blendy Boy", "Hiccupocalypse"],
      correct: 0,
      character: "Bomberdino Cocordilo",
      characterImage: "assets/characters/crocodilo.jpeg"
    },
    {
      id: 15,
      clue: "His last words before every nap are: ‚ÄòIf I don‚Äôt wake up, tell the moon I‚Äôm sorry.‚Äô",
      options: ["Croco BoomBoom", "Bomberdino Cocordilo", "Napalm Napster"],
      correct: 1,
      character: "Bomberdino Cocordilo",
      characterImage: "assets/characters/crocodilo.jpeg"
    },

    // IDs 16‚Äì20: Tralala Tralelero
    {
      id: 16,
      clue: "He doesn‚Äôt talk. He hums cryptic lullabies into bathroom tiles until they confess.",
      options: ["Sir Laughsalot", "Tralala Tralelero", "Echo Picasso"],
      correct: 1,
      character: "Tralala Tralelero",
      characterImage: "assets/characters/tralala.jpeg"
    },
    {
      id: 17,
      clue: "He once painted a door on a wall and disappeared into it. He‚Äôs been on a 'mental vacation' ever since.",
      options: ["Doodle Messiah", "Tralala Tralelero", "Exit.exe"],
      correct: 1,
      character: "Tralala Tralelero",
      characterImage: "assets/characters/tralala.jpeg"
    },
    {
      id: 18,
      clue: "Every full moon, he breakdances on rooftops to summon forgotten memes.",
      options: ["Rhymenstein", "Tralala Tralelero", "Urban Oracle"],
      correct: 1,
      character: "Tralala Tralelero",
      characterImage: "assets/characters/tralala.jpeg"
    },
    {
      id: 19,
      clue: "He once got arrested for spray-painting a love poem on the air.",
      options: ["DreamTagger", "Poem Punk", "Tralala Tralelero"],
      correct: 2,
      character: "Tralala Tralelero",
      characterImage: "assets/characters/tralala.jpeg"
    },
    {
      id: 20,
      clue: "He doesn‚Äôt enter buildings‚Äîhe phases through wallpaper patterns like a poetic poltergeist.",
      options: ["Haunted Hypebeast", "Tralala Tralelero", "Fresco Fugitivo"],
      correct: 1,
      character: "Tralala Tralelero",
      characterImage: "assets/characters/tralala.jpeg"
    }
  ],

  winningMessages: [
    "NFT burned, but you got the beat. ü•Å You‚Äôve summoned the Sahur spirit.",
    "The crows screamed your name. You guessed correctly.",
    "You signed with a üåÄ. The wedding was real.",
    "The lights flicker. Sahur is typing.",
    "You‚Äôve stared into the void. Sahur blinks.",
    "You just flipped braincells for culture. Banini approves.",
    "DAO approved your wisdom. Socks remain undecided.",
    "Fridge rejected. Brainrot accepted.",
    "The banana hit max volume. Brainrot gains confirmed.",
    "Whole collection swept. Enlightenment achieved üçåüß†",
    "Tail bitten, emotions analyzed‚ÄîCocordilo approved.",
    "Invisible armies salute you. Cocordilo reigns.",
    "Walls shattered. You feel the fallout.",
    "Existential tremors felt. Cocordilo triumphs.",
    "Moon whispers back. You passed the dream test.",
    "Tiles tremble with secrets. You heard the hum.",
    "Door painted. You followed the vanishing act.",
    "Memes rise from the rooftops. You led the dance.",
    "Air was your canvas. Poetry enforced.",
    "Walls bend around you. Ghost art complete."
  ],

  scoreResponses: {
    "1": {
      bigLine: "BRAINROT EXCELLENZA",
      phrases: [
        "Your socks are now hands‚Äîbattle ready.",
        "Microwave hum syncs with your neurons.",
        "You said 'Sahur' at the exact right moment."
      ]
    },
    "2": {
      bigLine: "DIAL-UP PROPHECY UNLOCKED",
      phrases: [
        "The JPEGs blinked first.",
        "Sahur echoes through your RAM.",
        "You sold air and made a profit‚ÄîBrainrot certified."
      ]
    },
    "3": {
      bigLine: "MEME MATRIMONY ACCEPTED",
      phrases: [
        "Elon sends his regards, nephew.",
        "Belt? No. Shoelace supremacy.",
        "Your signature glitched into a prophecy."
      ]
    },
    "4": {
      bigLine: "144P SHADOWS UNLEASHED",
      phrases: [
        "Your soul saved in Notepad.txt",
        "Loading spinner now worships you.",
        "Code hunger... satisfied."
      ]
    },
    "5": {
      bigLine: "STRATEGIC SAHUR VICTORY",
      phrases: [
        "Reverse walk initiated. You passed.",
        "Forbidden spaghetti decoded.",
        "Satoshi the Spoon blesses your fate."
      ]
    },
    "6": {
      bigLine: "SOUL SWAPPED FOR FLOOR",
      phrases: [
        "Your wallet smells like rug now.",
        "Hex tattoos glowing LFG.",
        "Banana JPEG verified ‚úÖ"
      ]
    },
    "7": {
      bigLine: "ON-CHAIN FOOT DECISIONS",
      phrases: [
        "Magic Eden just retweeted you.",
        "You paid in $BONK and it worked.",
        "Banana council nods in ape-proval."
      ]
    },
    "8": {
      bigLine: "BANANA SYSCALL DETECTED",
      phrases: [
        "You slept in a Ledger and woke up enlightened.",
        "Your voice now logs errors.",
        "Rug hairline, degen core."
      ]
    },
    "9": {
      bigLine: "FLOOR PRICE MENTALITY",
      phrases: [
        "You dipped and didn‚Äôt flinch.",
        "Banini screamed with you in unison.",
        "SOL might be down but you‚Äôre UP."
      ]
    },
    "10": {
      bigLine: "BANANA ZEN MASTER UNLOCKED",
      phrases: [
        "You now wear BananaCoin robes.",
        "Alpha group welcomes you silently.",
        "NFT peeled, truth revealed."
      ]
    },
    "11": {
      bigLine: "SELF-CARE EXPLODED",
      phrases: [
        "Dubstep roars echo in your head.",
        "Parking cones weep tears of fear.",
        "Shower floaties now mandatory."
      ]
    },
    "12": {
      bigLine: "FRIENDSHIP DETONATED",
      phrases: [
        "You tiptoe through minefields of feeling.",
        "Puddles received your apology.",
        "Screams speak louder than words."
      ]
    },
    "13": {
      bigLine: "UNLOCKED ALL EMOTIONAL BARRIERS",
      phrases: [
        "Detonations never looked so poetic.",
        "Arguments now in French bark.",
        "Fire alarms still waiting for a kiss."
      ]
    },
    "14": {
      bigLine: "HICCUP APOCALYPSE TRIGGERED",
      phrases: [
        "Microwave violence resonates in your chest.",
        "Rocket launchers for emotional support.",
        "Roommate blenders send farewell vibes."
      ]
    },
    "15": {
      bigLine: "LUNAR APOLOGY ACCEPTED",
      phrases: [
        "Reverse sleep patterns unlocked.",
        "Battery chewing now an art form.",
        "Bedtime tales no longer suspicious."
      ]
    },
    "16": {
      bigLine: "GRAFFITI GHOST HEARD",
      phrases: [
        "Laughter banned in three realms.",
        "Murals age backward before your eyes.",
        "Phone screens cracked‚Äîtruth revealed."
      ]
    },
    "17": {
      bigLine: "PORTAL ART ACTIVATED",
      phrases: [
        "Gallery spirits whisper in chalk.",
        "Rhymes echo in broken code.",
        "Morse tears line the canvas."
      ]
    },
    "18": {
      bigLine: "MOONLIT MEME RITUAL",
      phrases: [
        "Symmetry owes you favors.",
        "Tears and ketchup become paint.",
        "Berets cursed by your moves."
      ]
    },
    "19": {
      bigLine: "INVISIBLE ART INDICTED",
      phrases: [
        "Photobombs haunt your dreams.",
        "Sneezes sign every masterpiece.",
        "Boombox sidekicks echo the rhyme."
      ]
    },
    "20": {
      bigLine: "PATTERN PHASE UNLOCKED",
      phrases: [
        "Latin echoes backwards in halls.",
        "Ceilings judge no more.",
        "Mirrors reflect empty vibes."
      ]
    }
  }
};

// Game State Management
let gameState = {
  currentScreen: 'landing',
  currentRound: 0,
  score: 0,
  username: '',
  isLightMode: false,
  gameStarted: false
};

// Sound Effect Simulation
function playHorrorSound(soundType) {
  const sounds = {
    poke: "üîä POKE SOUND: *squelch*",
    bounce: "üîä BOUNCE SOUND: *boing*",
    correct: "üîä CORRECT SOUND: *demonic approval*",
    wrong: "üîä WRONG SOUND: *soul being devoured*",
    theme: "üîä THEME SOUND: *eerie horror ambiance*",
    transition: "üîä TRANSITION SOUND: *dimensional shift*",
    bloodDrip: "üîä BLOOD DRIP SOUND: *drip... drip...*",
    scream: "üîä SCREAM SOUND: *tormented wails*"
  };
  console.log(sounds[soundType] || "üîä UNKNOWN HORROR SOUND");
}

// Initialize Application
function init() {
  console.log('ü¶á Initializing BRAINROT TRIALS - Italian Horror Edition...');
  playHorrorSound('theme');
  
  // Wait a moment to ensure DOM is fully loaded
  setTimeout(() => {
    setupEventListeners();
    initializeFloatingCharacters();
    initializeTorchSystem();
    startHorrorEffects();
    console.log('üíÄ BRAINROT TRIALS initialized successfully! Welcome to your doom...');
  }, 100);
}

// Event Listeners Setup - FIXED with multiple event types and better targeting
function setupEventListeners() {
  console.log('üï∑Ô∏è Setting up event listeners...');
  
  // Theme toggle - multiple event types for better compatibility
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', handleThemeToggle);
    themeToggle.addEventListener('touchend', handleThemeToggle);
    console.log('‚úÖ Theme toggle listener attached');
  }
  
  // Landing page - FIXED: Multiple event types and better targeting
  const enterNightmareBtn = document.getElementById('enterNightmare');
  if (enterNightmareBtn) {
    enterNightmareBtn.addEventListener('click', handleEnterNightmare);
    enterNightmareBtn.addEventListener('touchend', handleEnterNightmare);
    enterNightmareBtn.style.pointerEvents = 'auto'; // Ensure button is clickable
    enterNightmareBtn.style.cursor = 'pointer';
    console.log('‚úÖ Enter Nightmare button listener attached');
  } else {
    console.error('‚ùå Enter Nightmare button not found!');
  }
  
  // Username screen - FIXED with better event handling
  const sealFateBtn = document.getElementById('sealFate');
  const backToLandingBtn = document.getElementById('backToLanding');
  const usernameInput = document.getElementById('usernameInput');
  
  if (sealFateBtn) {
    sealFateBtn.addEventListener('click', handleSealFate);
    sealFateBtn.addEventListener('touchend', handleSealFate);
    sealFateBtn.style.pointerEvents = 'auto';
    sealFateBtn.style.cursor = 'pointer';
    console.log('‚úÖ Seal Fate button listener attached');
  }
  
  if (backToLandingBtn) {
    backToLandingBtn.addEventListener('click', handleBackToLanding);
    backToLandingBtn.addEventListener('touchend', handleBackToLanding);
    backToLandingBtn.style.pointerEvents = 'auto';
    backToLandingBtn.style.cursor = 'pointer';
    console.log('‚úÖ Back to Landing button listener attached');
  }
  
  if (usernameInput) {
    usernameInput.addEventListener('input', validateUsername);
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        handleSealFate();
      }
    });
    console.log('‚úÖ Username input listeners attached');
  }
  
  // Dashboard
  const enterChaosBtn = document.getElementById('enterChaos');
  if (enterChaosBtn) {
    enterChaosBtn.addEventListener('click', handleEnterChaos);
    enterChaosBtn.addEventListener('touchend', handleEnterChaos);
    enterChaosBtn.style.pointerEvents = 'auto';
    enterChaosBtn.style.cursor = 'pointer';
    console.log('‚úÖ Enter Chaos button listener attached');
  }
  
  // Game options
  const option1 = document.getElementById('option1');
  const option2 = document.getElementById('option2');
  const option3 = document.getElementById('option3');
  const nextRound = document.getElementById('nextRound');
  
  if (option1) {
    option1.addEventListener('click', () => selectAnswer(0));
    option1.addEventListener('touchend', () => selectAnswer(0));
    option1.style.pointerEvents = 'auto';
    option1.style.cursor = 'pointer';
  }
  if (option2) {
    option2.addEventListener('click', () => selectAnswer(1));
    option2.addEventListener('touchend', () => selectAnswer(1));
    option2.style.pointerEvents = 'auto';
    option2.style.cursor = 'pointer';
  }
  if (option3) {
    option3.addEventListener('click', () => selectAnswer(2));
    option3.addEventListener('touchend', () => selectAnswer(2));
    option3.style.pointerEvents = 'auto';
    option3.style.cursor = 'pointer';
  }
  if (nextRound) {
    nextRound.addEventListener('click', proceedToNextRound);
    nextRound.addEventListener('touchend', proceedToNextRound);
    nextRound.style.pointerEvents = 'auto';
    nextRound.style.cursor = 'pointer';
  }
  
  // Results screen
  const playAgain = document.getElementById('playAgain');
  const shareTwitter = document.getElementById('shareTwitter');
  
  if (playAgain) {
    playAgain.addEventListener('click', handlePlayAgain);
    playAgain.addEventListener('touchend', handlePlayAgain);
    playAgain.style.pointerEvents = 'auto';
    playAgain.style.cursor = 'pointer';
  }
  
  if (shareTwitter) {
    shareTwitter.addEventListener('click', shareOnTwitter);
    shareTwitter.addEventListener('touchend', shareOnTwitter);
    shareTwitter.style.pointerEvents = 'auto';
    shareTwitter.style.cursor = 'pointer';
  }
  
  console.log('‚úÖ All event listeners setup complete');
}

// Event Handlers - FIXED to prevent default and handle properly
function handleThemeToggle(e) {
  e.preventDefault();
  e.stopPropagation();
  toggleTorchMode();
}

function handleEnterNightmare(e) {
  e.preventDefault();
  e.stopPropagation();
  console.log('üåÄ Enter Nightmare clicked!');
  playHorrorSound('transition');
  showScreen('username');
}

function handleSealFate(e) {
  if (e) {
    e.preventDefault();
    e.stopPropagation();
  }
  validateAndProceed();
}

function handleBackToLanding(e) {
  e.preventDefault();
  e.stopPropagation();
  playHorrorSound('transition');
  showScreen('landing');
}

function handleEnterChaos(e) {
  e.preventDefault();
  e.stopPropagation();
  startCountdown();
}

function handlePlayAgain(e) {
  e.preventDefault();
  e.stopPropagation();
  resetGame();
  showScreen('landing');
}

// Screen Management
function showScreen(screenName) {
  console.log(`üåÄ Transitioning to screen: ${screenName}`);
  playHorrorSound('transition');
  
  // Hide all screens
  const allScreens = ['landingPage', 'usernameScreen', 'dashboardScreen', 'gameScreen', 'resultsScreen'];
  allScreens.forEach(screenId => {
    const screen = document.getElementById(screenId);
    if (screen) {
      screen.classList.remove('active');
    }
  });
  
  // Show target screen
  let targetScreenId = '';
  switch(screenName) {
    case 'landing': targetScreenId = 'landingPage'; break;
    case 'username': targetScreenId = 'usernameScreen'; break;
    case 'dashboard': targetScreenId = 'dashboardScreen'; break;
    case 'game': targetScreenId = 'gameScreen'; break;
    case 'results': targetScreenId = 'resultsScreen'; break;
  }
  
  const targetScreen = document.getElementById(targetScreenId);
  if (targetScreen) {
    targetScreen.classList.add('active');
    gameState.currentScreen = screenName;
    console.log(`‚úÖ Screen changed to: ${screenName}`);
  } else {
    console.error(`‚ùå Screen not found: ${targetScreenId}`);
  }
  
  // Trigger screen-specific effects
  triggerScreenEffects(screenName);
}

function triggerScreenEffects(screenName) {
  if (screenName === 'dashboard') {
    updateDashboard();
  } else if (screenName === 'game') {
    startGame();
  } else if (screenName === 'results') {
    displayResults();
  }
}

// Theme Toggle - Torch System
function toggleTorchMode() {
  gameState.isLightMode = !gameState.isLightMode;
  const newTheme = gameState.isLightMode ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-color-scheme', newTheme);
  
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.textContent = gameState.isLightMode ? '‚òÄÔ∏è' : 'üåô';
  }
  
  console.log(`üî• Torch system ${gameState.isLightMode ? 'ACTIVATED' : 'DEACTIVATED'}`);
  playHorrorSound('transition');
}

// Interactive Floating Characters System
function initializeFloatingCharacters() {
  const characters = document.querySelectorAll('.interactive-char');
  
  characters.forEach((char, index) => {
    // Random initial positioning
    char.style.top = Math.random() * 70 + 15 + '%';
    char.style.left = Math.random() * 70 + 15 + '%';
    
    // Add click event for bounce and jiggle
    char.addEventListener('click', (e) => handleCharacterInteraction(e, char));
    char.addEventListener('touchstart', (e) => {
      e.preventDefault();
      handleCharacterInteraction(e, char);
    });
    
    // Ensure they're clickable
    char.style.pointerEvents = 'auto';
    char.style.cursor = 'pointer';
    
    // Continuous floating movement
    setInterval(() => {
      moveCharacterRandomly(char);
    }, (5000 + Math.random() * 5000));
  });
  
  console.log('üëπ Interactive floating characters initialized');
}

function handleCharacterInteraction(e, character) {
  e.preventDefault();
  e.stopPropagation();
  playHorrorSound('poke');
  
  // Add bouncing class
  character.classList.add('bouncing');
  
  // Random bounce direction
  const bounceX = (Math.random() - 0.5) * 200;
  const bounceY = (Math.random() - 0.5) * 200;
  
  // Calculate new position ensuring it stays in bounds
  const rect = character.getBoundingClientRect();
  const maxX = window.innerWidth - 60;
  const maxY = window.innerHeight - 60;
  
  let newX = Math.max(30, Math.min(maxX, rect.left + bounceX));
  let newY = Math.max(30, Math.min(maxY, rect.top + bounceY));
  
  // Convert to percentages
  newX = (newX / window.innerWidth) * 100;
  newY = (newY / window.innerHeight) * 100;
  
  character.style.left = newX + '%';
  character.style.top = newY + '%';
  
  // Add jiggle effect after bounce
  setTimeout(() => {
    character.classList.remove('bouncing');
    character.classList.add('jiggling');
    playHorrorSound('bounce');
    
    setTimeout(() => {
      character.classList.remove('jiggling');
    }, 500);
  }, 1000);
  
  console.log(`üí• Character ${character.dataset.char} was poked! Bouncing away...`);
}

function moveCharacterRandomly(character) {
  const newTop = Math.random() * 70 + 15 + '%';
  const newLeft = Math.random() * 70 + 15 + '%';
  
  character.style.transition = `all ${3 + Math.random() * 4}s ease-in-out`;
  character.style.top = newTop;
  character.style.left = newLeft;
}

// Torch System for Light Mode
function initializeTorchSystem() {
  const cursorTorch = document.getElementById('cursorTorch');
  if (!cursorTorch) return;
  
  // Cursor torch follows mouse
  document.addEventListener('mousemove', (e) => {
    if (gameState.isLightMode && cursorTorch) {
      cursorTorch.style.left = e.clientX + 'px';
      cursorTorch.style.top = e.clientY + 'px';
    }
  });
  
  console.log('üî• Torch system initialized');
}

// Horror Effects
function startHorrorEffects() {
  // Blood drip effect
  const bloodDrip = document.getElementById('bloodDripOverlay');
  if (bloodDrip) {
    setInterval(() => {
      playHorrorSound('bloodDrip');
      bloodDrip.style.animationDelay = Math.random() * 5 + 's';
    }, 15000);
  }
  
  // Screen flicker intensity variation
  const flicker = document.getElementById('screenFlicker');
  if (flicker) {
    setInterval(() => {
      const intensity = 0.01 + Math.random() * 0.02;
      flicker.style.opacity = intensity;
    }, 100);
  }
  
  console.log('üíÄ Horror effects activated');
}

// Username Validation - FIXED logic
function validateUsername() {
  const usernameInput = document.getElementById('usernameInput');
  const warning = document.getElementById('validationWarning');
  
  if (!usernameInput || !warning) return false;
  
  const username = usernameInput.value.trim();
  
  // Clear previous styling
  warning.style.color = 'var(--horror-red)';
  
  if (!username) {
    warning.textContent = '';
    return false;
  } else if (username.length < 3) {
    warning.textContent = 'Your name is too weak for the darkness! (Need 3+ characters)';
    return false;
  } else if (username.length > 15) {
    warning.textContent = 'Your name is too powerful! (Maximum 15 characters)';
    return false;
  } else if (!/^[a-zA-Z0-9\s]+$/.test(username)) {
    warning.textContent = 'Only letters, numbers, and spaces are allowed in this realm!';
    return false;
  } else {
    warning.textContent = '‚úì The spirits accept this name... proceed with caution.';
    warning.style.color = 'var(--horror-green)';
    console.log(`‚úÖ Username "${username}" is valid`);
    return true;
  }
}

function validateAndProceed() {
  console.log('üîç Validating username and proceeding...');
  
  if (validateUsername()) {
    const usernameInput = document.getElementById('usernameInput');
    gameState.username = usernameInput.value.trim();
    console.log(`‚úÖ Username accepted: ${gameState.username}`);
    playHorrorSound('transition');
    showScreen('dashboard');
  } else {
    const usernameInput = document.getElementById('usernameInput');
    const currentValue = usernameInput ? usernameInput.value.trim() : '';
    console.log(`‚ùå Username "${currentValue}" rejected`);
    playHorrorSound('wrong');
    showDramaticMessage("You cannot enter the chaos without a proper name, mortal!", 3000);
    if (usernameInput) usernameInput.focus();
  }
}

// Dashboard Functions
function updateDashboard() {
  const welcomeDoom = document.getElementById('welcomeDoom');
  if (welcomeDoom && gameState.username) {
    welcomeDoom.textContent = `Welcome to your doom, ${gameState.username.toUpperCase()}`;
  }
}

function startCountdown() {
  let count = 3;
  const timer = document.getElementById('countdownTimer');
  const button = document.getElementById('enterChaos');
  
  if (!timer || !button) return;
  
  button.disabled = true;
  button.textContent = 'PREPARING YOUR DOOM...';
  
  const countdown = setInterval(() => {
    timer.textContent = count;
    timer.style.transform = 'scale(1.5)';
    playHorrorSound('theme');
    
    setTimeout(() => {
      timer.style.transform = 'scale(1)';
    }, 500);
    
    count--;
    
    if (count < 0) {
      clearInterval(countdown);
      timer.textContent = 'DOOM!';
      timer.style.color = 'var(--horror-red)';
      playHorrorSound('scream');
      
      setTimeout(() => {
        showScreen('game');
      }, 1000);
    }
  }, 1000);
}

// Global variable to store the shuffled rounds safely
let shuffledRounds = [];

// Utility: Fisher-Yates Shuffle (correct!)
function shuffleArray(array) {
  const copy = [...array];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

// Start Game Function
function startGame() {
  const chaosMode = Math.random() > 0.5;

  // Shuffle without mutating original data
  shuffledRounds = shuffleArray(gameData.gameRounds);

  gameState.currentRound = 0;
  gameState.score = 0;
  gameState.gameStarted = true;

  console.log(`üß† You dare enter the BRAINROT TRIALS... Chaos Mode: ${chaosMode ? 'ON' : 'OFF'}`);
  console.log(`üé≤ Total Rounds: ${shuffledRounds.length}`);

  loadRound();
}



function loadRound() {
  const round = shuffledRounds[gameState.currentRound];
  
  // Update UI elements
  const currentRound = document.getElementById('currentRound');
  const gameClue = document.getElementById('gameClue');
  
  if (currentRound) currentRound.textContent = gameState.currentRound + 1;
  if (gameClue) gameClue.textContent = round.clue;
  
  // Set options
  const option1 = document.getElementById('option1');
  const option2 = document.getElementById('option2');
  const option3 = document.getElementById('option3');
  
  if (option1) {
    option1.textContent = round.options[0];
    option1.disabled = false;
    option1.classList.remove('correct', 'wrong');
  }
  
  if (option2) {
    option2.textContent = round.options[1];
    option2.disabled = false;
    option2.classList.remove('correct', 'wrong');
  }
  
  if (option3) {
    option3.textContent = round.options[2];
    option3.disabled = false;
    option3.classList.remove('correct', 'wrong');
  }
  
  // Update mystery character
  const mysteryChars = ['‚ùì', 'üé≠', 'üëª', 'üîÆ', 'üåÄ', '‚ö∞Ô∏è', 'üï∑Ô∏è', 'ü¶á'];
  const hiddenCharacter = document.getElementById('hiddenCharacter');
  if (hiddenCharacter) {
    hiddenCharacter.textContent = mysteryChars[gameState.currentRound % mysteryChars.length];
  }
  
  // Hide feedback
  const answerFeedback = document.getElementById('answerFeedback');
  if (answerFeedback) {
    answerFeedback.classList.add('hidden');
  }
  
  console.log(`üëπ Round ${gameState.currentRound + 1} loaded: ${round.clue.substring(0, 50)}...`);
}

function selectAnswer(selectedIndex) {

  if (navigator.vibrate) {
    navigator.vibrate(50);
  }

  const round = shuffledRounds[gameState.currentRound];
  const isCorrect = selectedIndex === round.correct;

  const successAudio = document.getElementById('successSound');
  const failureAudio = document.getElementById('failureSound');
  
  // Disable all buttons
  const option1 = document.getElementById('option1');
  const option2 = document.getElementById('option2');
  const option3 = document.getElementById('option3');
  
  if (option1) option1.disabled = true;
  if (option2) option2.disabled = true;
  if (option3) option3.disabled = true;
  
  // Visual feedback
  const buttons = [option1, option2, option3];
  const selectedButton = buttons[selectedIndex];
  const correctButton = buttons[round.correct];
  
  if (isCorrect) {
    if (selectedButton) selectedButton.classList.add('correct');
    gameState.score++;
    successAudio.currentTime = 0;
    successAudio.play().catch(() => {/* handle autoplay block */});
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
    playHorrorSound('correct');
    console.log('‚úÖ THE SPIRITS APPROVE!');
  } else {
    if (selectedButton) selectedButton.classList.add('wrong');
    if (correctButton) correctButton.classList.add('correct');
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
    failureAudio.currentTime = 0;
    failureAudio.play().catch(() => {/* handle autoplay block */});
    playHorrorSound('wrong');
    playHorrorSound('scream');
    
    // Screen shake effect
    document.body.classList.add('screen-shake');
    setTimeout(() => document.body.classList.remove('screen-shake'), 500);
    
    console.log('‚ùå YOUR SOUL HAS BEEN DEVOURED!');
  }
  
  // Show feedback after delay
  setTimeout(() => showAnswerFeedback(isCorrect, round), 1000);
}

function showAnswerFeedback(isCorrect, round) {
  const answerFeedback = document.getElementById('answerFeedback');
  const feedbackText = document.getElementById('feedbackText');
  const characterReveal = document.getElementById('characterReveal');
  const characterImg = document.getElementById('characterImage');
  const nextRound = document.getElementById('nextRound');

  answerFeedback.classList.remove('hidden');

  // text feedback
  if (feedbackText) {
    if (isCorrect) {
      const msg = gameData.winningMessages[
        Math.floor(Math.random() * gameData.winningMessages.length)
      ];
      feedbackText.textContent = msg;
      feedbackText.className = 'feedback-text correct';
    } else {
      feedbackText.textContent = "YOUR SOUL HAS BEEN DEVOURED üíÄüî•";
      feedbackText.className = 'feedback-text wrong';
    }
  }

  // name reveal
  if (characterReveal) {
    characterReveal.textContent = `Character Revealed: ${round.character}`;
  }

  // image reveal
  if (characterImg) {
    characterImg.src = round.characterImage;
    characterImg.classList.remove('hidden');
  }

  // next button text
  if (nextRound) {
    nextRound.textContent = gameState.currentRound >= gameData.gameRounds.length - 1
      ? "FACE YOUR JUDGMENT"
      : "DESCEND DEEPER";
  }

  // auto-advance after 3 seconds
  setTimeout(() => {
    // hide image again for next round
    if (characterImg) characterImg.classList.add('hidden');
    proceedToNextRound();
  }, 5000);
}

// 4Ô∏è‚É£ Make sure proceedToNextRound doesn‚Äôt immediately clear feedback until after the delay:
function proceedToNextRound() {
  const feedbackEl = document.getElementById('answerFeedback');

  if (feedbackEl) feedbackEl.classList.add('hidden');

  // Safeguard: don't go past total rounds
  if (gameState.currentRound < gameData.gameRounds.length - 1) {
    gameState.currentRound++;
    loadRound();
    playHorrorSound('transition'); // Optional spooky sound
  } else {
    // All rounds played, show result screen
    showScreen('results');
  }
}

// Results Screen
function displayResults() {
  const score = gameState.score;
  const scoreData = gameData.scoreResponses[score.toString()];
  
  const finalScore = document.getElementById('finalScore');
  const bigLine = document.getElementById('bigLine');
  const randomPhrase = document.getElementById('randomPhrase');
  
  if (finalScore) finalScore.textContent = score;
  if (bigLine) bigLine.textContent = scoreData.bigLine;
  
  // Random phrase
  const randomPhraseText = scoreData.phrases[Math.floor(Math.random() * scoreData.phrases.length)];
  if (randomPhrase) randomPhrase.textContent = randomPhraseText;
  
  // Dramatic entrance effect
  setTimeout(() => {
    if (finalScore) {
      finalScore.style.animation = 'scoreGlow 2s ease-in-out infinite';
    }
  }, 500);
  
  console.log(`üèÅ Game complete! Final score: ${score}/5 - ${scoreData.bigLine}`);
}

// Social Sharing
function shareOnTwitter() {
  const score = gameState.score;
  const scoreData = gameData.scoreResponses[score.toString()];
  
  const tweetText = `Just survived the BRAINROT TRIALS - Italian Horror Edition! üíÄüçù\n\nMy tormented soul achieved: ${score}/5\nVerdict: "${scoreData.bigLine}"\n\nDare to face your own nightmare? Enter if you can handle the chaos...\n\n#BrainrotTrials #ItalianHorror #MemeGame`;
  
  const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;
  window.open(twitterUrl, '_blank');
  
  playHorrorSound('scream');
  console.log('üê¶ Sharing torment on Twitter...');
}

// Game Reset
function resetGame() {
  gameState = {
    currentScreen: 'landing',
    currentRound: 0,
    score: 0,
    username: gameState.username, // Keep username
    isLightMode: gameState.isLightMode, // Keep theme
    gameStarted: false
  };
  
  // Reset countdown timer
  const countdownTimer = document.getElementById('countdownTimer');
  const enterChaos = document.getElementById('enterChaos');
  
  if (countdownTimer) {
    countdownTimer.textContent = '3';
    countdownTimer.style.color = 'var(--horror-green)';
  }
  
  if (enterChaos) {
    enterChaos.disabled = false;
    enterChaos.textContent = 'ENTER THE CHAOS';
  }
  
  console.log('üîÑ Game reset - Ready for another round of torment!');
  playHorrorSound('transition');
}

// Dramatic Message System
function showDramaticMessage(message, duration = 3000) {
  const messageElement = document.createElement('div');
  messageElement.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--horror-gray);
    color: var(--horror-red);
    padding: 30px 50px;
    border: 3px solid var(--horror-green);
    border-radius: 15px;
    font-family: var(--font-horror-body);
    font-size: 1.5rem;
    font-weight: bold;
    z-index: 9999;
    text-align: center;
    box-shadow: 0 0 50px rgba(139, 0, 0, 0.8);
    animation: feedbackPulse 1s ease;
    max-width: 80vw;
  `;
  messageElement.textContent = message;
  
  document.body.appendChild(messageElement);
  playHorrorSound('wrong');
  
  setTimeout(() => {
    if (messageElement.parentNode) {
      messageElement.parentNode.removeChild(messageElement);
    }
  }, duration);
}

function addEnhancedButtonEffects() {
  const buttons = document.querySelectorAll('.btn');
  
  buttons.forEach(button => {
    // Ensure buttons are properly clickable
    button.style.pointerEvents = 'auto';
    button.style.cursor = 'pointer';
    
    button.addEventListener('mouseenter', () => {
      if (!button.disabled) {
        // Light haptic feedback on hover (very subtle)
        if (hapticManager.supported) {
          hapticManager.vibrate(10);
        }
        playHorrorSound('theme');
      }
    });
    
    button.addEventListener('click', () => {
      if (!button.disabled) {
        button.style.transform = 'scale(0.95)';
        setTimeout(() => {
          button.style.transform = '';
        }, 100);
      }
    });
  });
}

// Konami Code Easter Egg
let konamiSequence = [];
const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];

document.addEventListener('keydown', (e) => {
  konamiSequence.push(e.code);
  
  if (konamiSequence.length > konamiCode.length) {
    konamiSequence.shift();
  }
  
  if (JSON.stringify(konamiSequence) === JSON.stringify(konamiCode)) {
    showDramaticMessage("üçù PASTA POWER ACTIVATED! The spirits reveal their secrets! üçù", 5000);
    playHorrorSound('scream');
    
    // Reveal correct answer if in game
    if (gameState.currentScreen === 'game' && gameState.gameStarted) {
      const currentRound = gameData.gameRounds[gameState.currentRound];
      const buttons = [
        document.getElementById('option1'),
        document.getElementById('option2'),
        document.getElementById('option3')
      ];
      const correctButton = buttons[currentRound.correct];
      
      if (correctButton) {
        correctButton.style.boxShadow = '0 0 30px var(--horror-green)';
        correctButton.style.border = '3px solid var(--horror-green)';
        
        setTimeout(() => {
          correctButton.style.boxShadow = '';
          correctButton.style.border = '2px solid var(--horror-green)';
        }, 8000);
      }
    }
    
    konamiSequence = [];
    console.log('üéÆ KONAMI CODE ACTIVATED! The ancient pasta spirits have blessed you!');
  }
});

document.addEventListener('DOMContentLoaded', () => {
  console.log('üåô DOM loaded - Awakening the enhanced horror...');
  init();
  setTimeout(() => {
    addEnhancedButtonEffects();
  }, 200);
});

// Backup initialization
window.addEventListener('load', () => {
  console.log('üîÑ Window loaded - Ensuring all enhanced elements are ready');
  setTimeout(() => {
    init();
    addEnhancedButtonEffects();
  }, 300);
});


// Triple backup - ensure initialization happens
setTimeout(() => {
  if (!document.getElementById('enterNightmare')?.onclick) {
    console.log('üîÑ Final backup initialization triggered');
    init();
    addEnhancedButtonEffects();
  }
}, 1000);

// Export for debugging
window.BrainrotHorror = {
  gameState,
  gameData,
  showScreen,
  toggleTorchMode,
  resetGame,
  playHorrorSound,
  handleEnterNightmare,
  validateAndProceed
};

console.log('üíÄ BRAINROT TRIALS - Italian Horror Edition loaded! Your nightmare begins now...');
playHorrorSound('theme');